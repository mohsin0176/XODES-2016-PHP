<html>
<head>
<title>Online Voting System – Results</title>
</head>
<body>

<h2>Results (Non-manipulative and Non-partial)</h2>

<?php

if ($_GET['qid'] && is_numeric($_GET['qid'])) {
    // ??????? ?????????? ???? ??? ???
    include('config.php');

    // ??????? ????? ???? ???
    $connection = mysql_connect($host, $user, $pass) or die('ERROR: Unable to connect!');

    // ??????? ??????? ???
    mysql_select_db($db) or die('ERROR: Unable to select database!');

    // ?????? ?????? ????? ??? 
    $query = "SELECT qtitle FROM questions WHERE qid = '".$_GET['qid']."'";
    $result = mysql_query($query) or die("ERROR: $query. ".mysql_error());
    $row = mysql_fetch_object($result);
    echo '<h3>'.$row->qtitle.'</h3>';

    // ?????????????? ????? ???
    unset($query);
    unset($result);
    unset($row);

    // ???? ??? ???? ????? ?? ?? ??? ???
    $query = "SELECT qid, SUM(acount) AS total FROM answers GROUP BY qid HAVING qid = ".$_GET['qid'];
    $result = mysql_query($query) or die("ERROR: $query. ".mysql_error());
    $row = mysql_fetch_object($result);
    $total = $row->total;

    // ??? ???? ???
    if ($total > 0) {
        // ?????????????? ????? ???
        unset($query);
        unset($result);
        unset($row);

        // ??????? ??????? ??????? ??? ???
        $query = "SELECT atitle, acount FROM answers WHERE qid = '".$_GET['qid']."'";
        $result = mysql_query($query) or die("ERROR: $query. ".mysql_error());

        // ?????? ?????
        if (mysql_num_rows($result) > 0) {
            // ????? ?? ????? ????? ??????? ???
            echo '<table border=1 cellspacing=0 cellpadding=15>';

            // ??? ???
            // ??????? ? ????? ???? ?? ?????? ???
            while($row = mysql_fetch_object($result)) { 
                echo '<tr>';
                echo '<td>'.$row->atitle.'</td>';
                echo '<td>'.$row->acount.'</td>';
                echo '<td>';
                for ($i = 0; $i < (int)($row->acount*100 / $total); $i++) echo "<img src='mainbar.gif'"; 
                //for ($i = 0; $i < (int)($row->acount*50 / $total); $i++) echo "*";
                echo '</td>';
                echo '<td>'.round(($row->acount/$total) * 100, 2).'%</td>';
                echo '</tr>';
            }

            // ??? ????? ?????? ?????? ???
            echo '<tr>';
            echo '<td><u>TOTAL</u></td>';
            echo '<td>'.$total.'</td>';
            echo '<td> &nbsp;</td>';
            echo '<td>100%</td>';
            echo '</tr>';
            echo '</table>';
        }
    }
    // ???? ??? ???? ?? ??? ?????? ???
    else {
        echo 'No votes cast yet';
    }

    // ??????? ????? ???? ???
    mysql_close($connection);
}
else {
    die('ERROR: Data not correctly submitted');
}



?>

</body>
</html> 
